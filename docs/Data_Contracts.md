# Data Contracts

## 1. Purpose

This document defines the **canonical data contracts** used between the backend data service and the frontend visualization layer.

A *data contract* specifies:

* the shape of the data exchanged
* field names and types
* time and numeric conventions
* required invariants and guarantees

These contracts are **independent of storage format** (Parquet, CSV) and **independent of frontend implementation details**. They represent the authoritative interface boundary between system components.

All backend API responses must conform to these contracts.

---

## 2. Global Conventions

### 2.1 Time Representation

All timestamps:

* are **UTC**
* are represented as **UNIX epoch seconds**
* are integers (no floating-point timestamps)

The meaning of a timestamp is:

* **bar open time**, unless explicitly documented otherwise

No timestamps in milliseconds are allowed.

---

### 2.2 Ordering

All time-series arrays:

* MUST be sorted in ascending time order
* MUST NOT contain duplicate timestamps within a single series

---

### 2.3 Numeric Values

* All numeric values are JSON numbers
* `NaN`, `Infinity`, and `-Infinity` are **not allowed**
* Missing values are represented by **omission**, not placeholders

---

### 2.4 Consistency

Within a single response:

* all series referring to the same contract must share the same time domain
* indicator series must align with bar timestamps, except where values are missing and omitted

---

## 3. Candle (Bar) Contract

### 3.1 Purpose

Represents OHLC price data for rendering candlestick charts.

### 3.2 Model

```json
Candle {
  "time": number,
  "open": number,
  "high": number,
  "low": number,
  "close": number
}
```

### 3.3 Field Semantics

| Field   | Description                        |
| ------- | ---------------------------------- |
| `time`  | Bar open time in UTC epoch seconds |
| `open`  | Opening price                      |
| `high`  | Highest price during bar           |
| `low`   | Lowest price during bar            |
| `close` | Closing price                      |

### 3.4 Invariants

* `high >= max(open, close)`
* `low <= min(open, close)`
* Bars must be contiguous according to the selected timeframe (subject to market hours)

---

## 4. Indicator Series Contract

### 4.1 Purpose

Represents a single logical technical indicator series (e.g., EMA, VWAP, RSI).

Each indicator is expressed as a standalone time series aligned to bar timestamps.

### 4.2 Model

```json
IndicatorSeries {
  "id": string,
  "name": string,
  "kind": "line" | "histogram",
  "pane": string,
  "data": IndicatorPoint[]
}

IndicatorPoint {
  "time": number,
  "value": number
}
```

### 4.3 Field Semantics

| Field  | Description                               |
| ------ | ----------------------------------------- |
| `id`   | Stable identifier (e.g., `ema_21`)        |
| `name` | Human-readable name                       |
| `kind` | Rendering hint (`line` or `histogram`)    |
| `pane` | Target pane (`price`, `rsi`, `atr`, etc.) |
| `data` | Time-ordered indicator values             |

### 4.4 Pane Semantics

* `price` → overlay on candlestick chart
* any other value → rendered in its own sub-pane
* pane names must be consistent across series to allow grouping

---

### 4.5 Invariants

* Indicator points must:

  * be sorted by time
  * use the same `time` domain as candles
* Missing indicator values must be omitted (no `null` entries)
* Indicator data must not introduce timestamps outside the candle range

---

## 5. Trade Contract

### 5.1 Purpose

Represents executed trades generated by a backtesting system.

Trades are modeled as **round-trip positions** (entry + exit) for v1.

### 5.2 Trade Model

```json
Trade {
  "id": string,
  "side": "long" | "short",
  "entryTime": number,
  "entryPrice": number,
  "exitTime": number,
  "exitPrice": number,
  "qty": number,
  "pnl": number | null,
  "flags": string[]
}
```

### 5.3 Field Semantics

| Field        | Description             |
| ------------ | ----------------------- |
| `id`         | Unique trade identifier |
| `side`       | Position direction      |
| `entryTime`  | Entry timestamp         |
| `entryPrice` | Entry price             |
| `exitTime`   | Exit timestamp          |
| `exitPrice`  | Exit price              |
| `qty`        | Position size           |
| `pnl`        | Optional profit/loss    |
| `flags`      | Validation warnings     |

---

### 5.4 Trade Invariants

* `entryTime < exitTime`
* `entryPrice > 0`
* `exitPrice > 0`
* Trade times must fall within the candle time range

---

## 6. Trade Marker Contract

### 6.1 Purpose

Defines chart annotations corresponding to trade entry and exit events.

Markers are rendered directly on the candlestick series.

### 6.2 Model

```json
TradeMarker {
  "time": number,
  "position": "aboveBar" | "belowBar",
  "shape": "arrowUp" | "arrowDown",
  "color": string,
  "text": string
}
```

### 6.3 Mapping Rules

* Long entry → `belowBar`, `arrowUp`
* Long exit → `aboveBar`, `arrowDown`
* Short entry → `aboveBar`, `arrowDown`
* Short exit → `belowBar`, `arrowUp`

Markers must reference valid candle timestamps.

---

## 7. Validation Flags

### 7.1 Purpose

Flags indicate potential data issues without failing the request.

### 7.2 Common Flags

| Flag                 | Meaning                              |
| -------------------- | ------------------------------------ |
| `TIME_SKEW`          | Trade timestamp far from nearest bar |
| `PRICE_OUT_OF_RANGE` | Price outside bar high/low           |
| `MISSING_BAR`        | No matching bar found                |

Flags are informational and intended for UI highlighting.

---

## 8. Response Aggregates

Some endpoints return compound objects.

Example:

```json
{
  "candles": Candle[],
  "series": IndicatorSeries[],
  "trades": Trade[],
  "markers": TradeMarker[]
}
```

All embedded arrays must conform to the contracts defined above.

---

## 9. Compatibility with TradingView Lightweight Charts

These contracts are intentionally aligned with the input requirements of TradingView Lightweight Charts:

* `time` fields match expected UNIX timestamp format
* OHLC candle shape matches `candlestickSeries.setData`
* Indicator series match `lineSeries.setData`
* Markers match `series.setMarkers`

The frontend should be able to pass data directly to the chart library without reshaping.

---

## 10. Contract Stability

These contracts are considered **stable for v1**.

Changes must:

* be documented here
* be reflected in backend and frontend simultaneously
* maintain backward compatibility where possible

---

## 11. Non-Goals

This document does not describe:

* storage schemas (Parquet, CSV)
* internal backend structs
* frontend component structure
* UI layout or styling

It exists solely to define **what data is exchanged and what guarantees are made**.

